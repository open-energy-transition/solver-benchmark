name: CI

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allows you to run this workflow manually from the Actions tab
  # workflow_dispatch:

jobs:
  CI:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Set up virtual environment and install dependencies
        run: |
          python -m venv /tmp/venv
          source /tmp/venv/bin/activate
          pip install --upgrade pip
          sudo apt update
          sudo apt install -y glpk-utils libglpk-dev
          pip install -r runner/requirements.txt
          pip install git+https://github.com/PyPSA/linopy.git@40a27f9e7f5d33acd1d256334a1b193899b166ad

      - name: Check code formatting
        run: |
          pip install pre-commit
          pre-commit install
          pre-commit run --all-files

      - name: Install Dependencies for Streamlit App Action
        run: |
            pip install -r website/requirements.txt

      - name: Run Streamlit App Action
        uses: streamlit/streamlit-app-action@v0.0.3
        with:
            app-path: website/app.py

      - name: Run sample benchmarks
        run: |
          source /tmp/venv/bin/activate
          python runner/run_benchmarks.py benchmarks/tests.yaml

          if awk -F',' 'NR>1 {if ($3 != "ok") exit 1}' results/benchmark_results.csv; then
            echo "All benchmarks ran successfully."
          else
            echo "Some benchmarks did not complete successfully."
            exit 1
          fi
