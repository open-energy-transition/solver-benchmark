# Instructions

This folder contains benchmarks based on PyPSA and PyPSA-Eur. The benchmarks can be generated by following these steps: (TODO replace this with a CI script)

1. Clone the repo [PyPSA-Eur](https://github.com/PyPSA/pypsa-eur) and checkout commit `a69373b9`.

1. Install the conda/mamba environment for pypsa-eur and install our custom branch of `linopy` on top of it by:
     ```bash
     micromamba env create -f envs/environment.yaml
     micromamba activate pypsa-eur
     pip install git+https://github.com/open-energy-transition/linopy.git@only-generate-problem-files --no-deps
     ```

1. Run the following commands to generate the NC files for each benchmark. This assumes your current working directory is `pypsa-eur/` and that this repo is checked out at `~/code/solver-benchmarks/`; modify this path accordingly.
     ```bash
     time snakemake -call all --cores all --printshellcmds --configfile  ~/code/solver-benchmark/benchmarks/pypsa/pypsa-eur-sec-2-lv1-3h.yaml ; echo -e '\a'
     time snakemake -call solve_elec_networks --cores all --printshellcmds --configfile  ~/code/solver-benchmark/benchmarks/pypsa/pypsa-eur-elec-10-lvopt-3h.yaml ; echo -e '\a'
     time snakemake -call results/networks/elec_s_20_ec_lv1_24h_op.nc --cores all --printshellcmds --configfile  ~/code/solver-benchmark/benchmarks/pypsa/pypsa-eur-elec-20-lv1-3h-op.yaml ; echo -e '\a'
     time snakemake -call results/networks/elec_s_20_ec_lv1_24h_op.nc --cores all --printshellcmds --configfile  ~/code/solver-benchmark/benchmarks/pypsa/pypsa-eur-elec-20-lv1-3h-op-ucconv.yaml ; echo -e '\a'
     time python pypsa-wind+sol+ely-1h-ucgas.py
     time python pypsa-wind+sol+ely-1h.py
     ```
     When the command exits, look for an output line like follows:
     ```
     INFO:linopy.model:Solver problem file written as NetCDF to `/tmp/linopy-problem-m901fbu6.nc`.
     ```
     Then, copy the NC file from the given path to `solver-benchmarks/runner/benchmarks/`.

Note, in order to generate the 1st benchmark, the following patch needs to be applied to pypsa-eur commit `a69373b9`:
```diff
diff --git a/scripts/prepare_sector_network.py b/scripts/prepare_sector_network.py
index 8748b64f..c761ac50 100755
--- a/scripts/prepare_sector_network.py
+++ b/scripts/prepare_sector_network.py
@@ -2512,7 +2512,7 @@ def add_biomass(n, costs):
             bus=spatial.biomass.nodes_unsustainable,
             carrier="unsustainable solid biomass",
             e_nom=unsustainable_solid_biomass_potentials_spatial,
-            marginal_cost=costs.at["fuelwood", "fuel"],
+            marginal_cost=costs["fuel"],
             e_initial=unsustainable_solid_biomass_potentials_spatial,
             e_nom_extendable=False,
             e_max_pu=e_max_pu,
@@ -2547,7 +2547,7 @@ def add_biomass(n, costs):
             bus=spatial.biomass.bioliquids,
             carrier="unsustainable bioliquids",
             e_nom=unsustainable_liquid_biofuel_potentials_spatial,
-            marginal_cost=costs.at["biodiesel crops", "fuel"],
+            marginal_cost=costs["fuel"],
             e_initial=unsustainable_liquid_biofuel_potentials_spatial,
             e_nom_extendable=False,
             e_max_pu=e_max_pu,
@@ -2690,7 +2690,7 @@ def add_biomass(n, costs):
                 bus=spatial.biomass.nodes_unsustainable,
                 carrier="unsustainable solid biomass",
                 p_nom=10000,
-                marginal_cost=costs.at["fuelwood", "fuel"]
+                marginal_cost=costs["fuel"]
                 + bus_transport_costs * average_distance,
             )
             # Set last snapshot of e_max_pu for unsustainable solid biomass to 1 to make operational limit work
diff --git a/scripts/solve_network.py b/scripts/solve_network.py
index bdc10dd1..419ca641 100644
--- a/scripts/solve_network.py
+++ b/scripts/solve_network.py
@@ -1074,6 +1074,7 @@ def solve_network(n, config, params, solving, **kwargs):
         solving["solver_options"][set_of_options] if set_of_options else {}
     )
     kwargs["solver_name"] = solving["solver"]["name"]
+    kwargs["only_generate_problem_file"] = cf_solving.get("only_generate_problem_file", False)
     kwargs["extra_functionality"] = extra_functionality
     kwargs["transmission_losses"] = cf_solving.get("transmission_losses", False)
     kwargs["linearized_unit_commitment"] = cf_solving.get(
```

## PyPSA-EUR-based sample problems (pypsa-eur-sec-2-lv1-3h, pypsa-eur-elec-10-lvopt-3h, pypsa-eur-elec-20-lv1-3h-op, pypsa-eur-elec-20-lv1-3h-op-ucconv)
- First, follow the traditional steps for PyPSA-EUR [installation](https://pypsa-eur.readthedocs.io/en/latest/installation.html).
- Get the config files for the sample problems from ... and put them in `/pypsa-eur/config`
- Get the `solver_benchmark_pypsa_eur.py` and place it in the `/pypsa-eur` folder
- In order to produce the .lp files, the line  `kwargs["keep_files"] = cf_solving.get("keep_files", True)` must be added to `/pypsa-eur/scripts/solve_network.py` (can be added anywhere under `def solve_network(n, config, solving, **kwargs):` among the several **kwargs extra arguments
- Run the solver_benchmark_pypsa_eur.py file: `python solver_benchmark_pypsa_eur.py --configfile config/your_config_file.yaml` (where `your_config_file` has to be replaced with either `pypsa-eur-sec-2-lv1-3h`, `pypsa-eur-elec-10-lvopt-3h`, `pypsa-eur-elec-20-lv1-3h-op` or `pypsa-eur-elec-20-lv1-3h-op-ucconv`)
- The generated .lp file will be located in `/tmp`

## Simpler sample problems (pypsa-wind+sol+ely-1h, pypsa-wind+sol+ely-1h-ucgas)
- First, follow the traditional steps for PyPSA-EUR [installation](https://pypsa-eur.readthedocs.io/en/latest/installation.html) (ignore if already executed, but the `pypsa-eur` environment is required anyway.
- Run `python pypsa-wind+sol+ely-1h.py` and `pypsa-wind+sol+ely-1h-ucgas.py`
- The .lp file will be automatically produced thanks to the `keep_files=True` argument passed to `n.optimize()` and located in `/tmp`
